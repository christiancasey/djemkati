{% extends 'base.html' %}

<html>
	<head>
		<meta charset="utf-8">
		<title>Page Detail</title>
		
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
		<link rel="stylesheet" href="{% static 'css/sobti_style.css' %}">
		
	</head>
	<body>
		
		
    
		{% if page %}
			<div class="dashboard">
				<div class="header">
					<h1>
						<a href="{% url 'sobti:manuscripts' page.manuscript.text.id %}">{{ page.manuscript.text.title }}</a> â€“ 
						<a href="{% url 'sobti:pages' page.manuscript.text.id page.manuscript.id %}">{{ page.manuscript.collection.name }}: {{ page.manuscript.accession_number }}</a>, 
						Page {{ page.number_in_manuscript }}
					</h1>
				</div>
					
				<div class="work_surface">
						
					<div class="text_wrapper">
						<canvas id="canvas"></canvas>
					</div>
					
					<div class="sign_list">
						<div class="accordion" id="lineSet" style="max-height: 100%; width: 100%;">
							
							{% for line in page.line_set.all %}
							<div class="card" style="width: 100%;">
								<div id="draw_line_{{ line.pk }}">
									<div class="card-header" id="line{{ line.number_in_page }}">
										<h2 class="mb-0">
											<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#glyphs{{ line.number_in_page }}" aria-expanded="true" aria-controls="glyphs{{ line.number_in_page }}" style="width:40vw;">
												<h2 id="line_header_{{ line.number_in_page }}">Line {{ line.number_in_page }}</h2>
											</button>
										</h2>
									</div>
								</div>

								<div id="glyphs{{ line.number_in_page }}" class="collapse show" aria-labelledby="line{{ line.number_in_page }}" data-parent="#lineSet">
									<div class="card-body" style="margin: 0; padding: 0;">
										
										<ul class="list-group" style="margin: 0; padding: 0;">
											
											{% for glyph in line.glyph_set.all %}
												
												<li class="list-group-item">
													<div id="draw_glyph_{{ glyph.pk }}">
														<div class="input-group">
															
															<div class="input-group-prepend">
																<div class="sign_move_buttons">
																	<input value="&#x2B06;" type="button" class="move_sign_up" />
																	<input value="&#x2B07;" type="button" class="move_sign_down" />
																</div>
																<div class="glyph_in_line">
																	<h3>{{ glyph.number_in_line }}</h3>
																</div>
																	<div class="glyph_image_container">
																		<img src="{{ glyph.image.url }}" />
																	</div>
															</div>
														
														
															<!-- <input value="{{ glyph.number_in_line }}" placeholder="&#x2116;" type="text" aria-label="glyph_{{glyph.pk}}_number_in_line" class="number_input" maxlength="3" /> -->
															<!-- <input value="{{ glyph.number_in_page }}" type="text" aria-label="glyph_{{glyph.pk}}_number_in_page" class="form-control"> -->
															<input value="{{ glyph.unicode_glyphs }}" placeholder="&#x13000;&#x13050;&#x133E5;" type="text" aria-label="glyph_{{glyph.pk}}_unicode_glyphs" class="glyph_input" maxlength="3" />
															<input value="{{ glyph.manuel_de_codage }}" placeholder="A1*B1:Z2" type="text" aria-label="glyph_{{glyph.pk}}_manuel_de_codage" class="text_input" maxlength="10" />
															<input value="{{ glyph.moller_number }}" placeholder="&#x1D578;" type="text" aria-label="glyph_{{glyph.pk}}_moller_number" class="number_input" maxlength="5" />
															<input value="{{ glyph.mainz_number }}" placeholder="PAK" type="text" aria-label="glyph_{{glyph.pk}}_mainz_number" class="number_input" maxlength="12" />
														</div>
													</div>
												</li>
												
											{% endfor %}
										</ul>
										
									</div>
								</div>
							
							</div>
							{% endfor %}
							
							<div class="card" style="width: 100%; height: 65vh;">
							</div>
						</div>
						
						<!-- <div id="target">
						  Click here
						</div>
						<div id="other">
						  Trigger the handler
						</div> -->
					</div>
				</div>
			</div>
		{% endif %}


		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>

		<!-- <script src="{% static 'js/sobti.js' %}"></script> -->
		{% block javascript %}{% endblock %}

		<script>
		var nLines = {{ page.line_set.all|length }};
	  var vHLinePolygons = Array(nLines);
	  var vCMLines = iris(nLines);
	  $( document ).ready(function(){
	    
	    
	    
	    vCMGlyphs = new Array({{ page.line_set.all|length }}).fill([]);
	    
	    {% for line in page.line_set.all %}
	      
	      vLineColor = vCMLines[{{ forloop.counter0 }}];
	      $("#line_header_{{ line.number_in_page }}").css('color', "rgb(" + vLineColor.toString() + ")");
	      $("#line_header_{{ line.number_in_page }}").css('background-color', "rgb(" + vLineColor.map(function(f) {return f*0.25+193;}).toString() + ")")
	      
	      iLine = {{ forloop.counter0 }};
	      $("#draw_line_{{ line.pk }}").mouseout( function(e) {
	        clearCanvas();
	      } );
	      
	      $("#draw_line_{{ line.pk }}").mouseover( function(e) {
	        e.preventDefault();
	        var iPk = {{ line.pk }};
	        
	        $.ajax({
	          type: 'GET',
	          url: "{% url 'sobti:get_polygon' %}",
	          data: {'pk': iPk, 'type': 'line'},
	          
	          success: function (response) {
	            clearCanvas();
	            var polygonPoints = response["polygon"]
	            vLineColor = vCMLines[{{ forloop.counter0 }}];
	            sFillColor = "rgba(" + [].concat(vLineColor, [0.8]).toString() + ")"
	            sStrokeColor = "rgba(" + [].concat(vLineColor, [0.7]).toString() + ")"
	            // vHLinePolygons[{{ forloop.counter0 }}] = ctx.fillPolygon(polygonPoints, sFillColor, sStrokeColor, 10);
	            vHLinePolygons[{{ forloop.counter0 }}] = ctx.fillPolygon(polygonPoints, null, sStrokeColor, 6);
	          },
	          error: function (response) {
	            console.log(response)
	          }
	        });
	      } );
	      
	      var nGlyphs = {{ line.glyph_set.all|length }};
	      vCMGlyphs[{{ forloop.counter0 }}] = iris(nGlyphs);
	      console.log(vCMGlyphs);
	      {% for glyph in line.glyph_set.all %}
	        $("#draw_glyph_{{ glyph.pk }}").focusout( function(e) {
	          clearCanvas();
	        } );
	        
	        $("#draw_glyph_{{ glyph.pk }}").on( 'mouseover focusin', function(e) {
	          e.preventDefault();
	          var iPk = {{ glyph.pk }};
	          
	          console.log(iPk);
	          
	          $.ajax({
	            type: 'GET',
	            url: "{% url 'sobti:get_polygon' %}",
	            data: {'pk': iPk, 'type': 'glyph'},
	            
	            success: function (response) {
	              clearCanvas();
	              var polygonPoints = response["polygon"];
	              vGlyphColor = vCMGlyphs[{{ forloop.parentloop.counter0 }}][{{ forloop.counter0 }}];
	              console.log(vGlyphColor)
	              sFillColor = "rgba(" + [].concat(vGlyphColor, [0.6]).toString() + ")"
	              sStrokeColor = "rgba(" + [].concat(vGlyphColor, [0.7]).toString() + ")"
	              // ctx.fillPolygon(polygonPoints, sFillColor, sStrokeColor, 4);
	              ctx.fillPolygon(polygonPoints, sFillColor, null, 4);
	            },
	            error: function (response) {
	              console.log(response)
	            }
	          });
	        } );
	      {% endfor %}
	    {% endfor %}
	  });
		
		function clearCanvas() {
	    var canvas = document.getElementById("canvas");
	    ctx = canvas.getContext("2d");
	    
	    canvas.width = {{ facsimile.width }};
	    canvas.height = {{ facsimile.height }};
	    
	    ctx.clearRect(0,0,canvas.width,canvas.height); 
	    var background = new Image();
	    background.src = "{{ facsimile.url }}";
	      ctx.drawImage(background,0,0);
	  }
	  
		
		  function iris(m) {
		    fPurple = 2*Math.PI/3.0;
		    fScale = 0.8;
		    fOffset = 0.0;
		    vCM = new Array(m).fill(Array(3).fill(0));
		    
		    for(i=0;i<m;i++) {
		      fTh = (i/m) * (Math.PI*2 - fPurple)
		      vCM[i] = [ 255*(fScale*(Math.cos(fTh)+1)/2+fOffset), 255*(fScale*(Math.cos(fTh-2*Math.PI/3)+1)/2+fOffset), 255*(fScale*(Math.cos(fTh-4*Math.PI/3)+1)/2+fOffset) ];
		    }
		    return vCM;
		  }

	  
		
		  //create and fill polygon
		  CanvasRenderingContext2D.prototype.fillPolygon = function (pointsArray, fillColor, strokeColor, linewidth) {
		    if (pointsArray.length <= 0) return;
		    this.moveTo(pointsArray[0][0], pointsArray[0][1]);
		    for (var i = 0; i < pointsArray.length; i++) {
		        this.lineTo(pointsArray[i][0], pointsArray[i][1]);
		    }
		    if (strokeColor != null && strokeColor != undefined) {
		      this.strokeStyle = strokeColor;
		      this.lineWidth = linewidth;
		      this.imageSmoothingEnabled = true;
		      this.imageSmoothingQuality = 'high';
		      this.lineCap = 'round';
		      this.lineJoin = 'round';
		      this.closePath();
		      this.stroke();
		    }

		    if (fillColor != null && fillColor != undefined) {
		      this.fillStyle = fillColor;
		      this.fill();
		    }
		    return this;
		  }



		  function setBackground() {
		    
		    var canvas = document.getElementById("canvas");
		    ctx = canvas.getContext("2d");

		    canvas.width = {{ facsimile.width }};
		    canvas.height = {{ facsimile.height }};
		    
		    ctx.clearRect(0,0,canvas.width,canvas.height);
		    
		    var background = new Image();
		    background.src = "{{ facsimile.url }}";
		    background.onload = function(){
		      ctx.drawImage(background,0,0);   
		    }
		  }

		</script>

	</body>
</html>